<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/jsonfavicon.ico" type="image/x-ico" />
    <title>Generar y Descargar JSON</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Rye&display=swap");
      /* General */
      body {
        font-family: "Inter", sans-serif; /* Fuente moderna */
        background-color: #f0f2f5; /* Fondo claro */
        color: #333333; /* Texto oscuro */
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
      }

      h1 {
        font-size: 3rem;
        margin-bottom: 20px;
        text-align: center;
        color: #4e91f6; /* Azul suave */
        font-weight: 600;
      }

      .container {
        width: 100%;
        max-width: 900px;
        background: #ffffff; /* Fondo blanco */
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0px 10px 40px rgba(0, 0, 0, 0.1); /* Sombra sutil */
        display: flex;
        flex-direction: column;
        align-items: center;
        border: 1px solid #4e91f6;
      }

      h1,
      label {
        font-family: "Inter", sans-serif;
      }

      /* Estilo de los campos */
      .form-group {
        width: 100%;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
      }

      label {
        font-size: 1rem;
        margin-bottom: 8px;
        color: #333333;
        font-weight: bold;
      }

      input,
      select,
      button {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        outline: none;
        box-shadow: inset 0px 2px 6px rgba(0, 0, 0, 0.1);
      }

      input,
      select {
        background: #fafafa; /* Fondo claro */
        color: #333333; /* Texto oscuro */
        margin-bottom: 12px;
      }

      input:focus,
      select:focus {
        border-color: #4e91f6; /* Azul al foco */
      }

      button {
        background: linear-gradient(45deg, #4e91f6, #1e79e4); /* Degradado suave */
        color: #ffffff;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.3s, box-shadow 0.3s;
      }

      button:hover {
        transform: translateY(-4px);
        box-shadow: 0px 5px 15px rgba(78, 145, 246, 0.6);
      }

      /* Estilo de la lista de campos */
      .field-list {
        width: 100%;
        margin: 20px 0;
        padding: 15px;
        background: #f7f7f7;
        border-radius: 8px;
        max-height: 220px;
        overflow-y: auto;
        border: 1px solid #ccc;
      }

      .field-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding: 10px;
        background: #f1f1f1;
        border-radius: 8px;
      }

      .field-item span {
        font-size: 1rem;
        color: #333333;
      }

      .field-item button {
        background: #e57373;
        font-size: 0.9rem;
        padding: 5px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        color: #ffffff;
        transition: background 0.3s;
      }

      .field-item button:hover {
        background: #d32f2f;
      }
      #history {
        width: 100%;
        margin-top: 20px;
        color: #00ff00; /* Verde clásico de las terminales antiguas */
        padding: 20px;
        border-radius: 5px;
        border: 2px solid #14121b; /* Borde verde */
        font-family: "Courier New", monospace;
        font-size: 1.1rem;
        line-height: 1.6;
        overflow-y: auto;
        max-height: 300px;
        box-shadow: 0 0 20px rgb(22 26 25);
        white-space: pre-wrap; /* Permite que el texto se ajuste correctamente */
        word-wrap: break-word; /* Evita que el texto se desborde */
        background: linear-gradient(90deg, #171717, #313131);
        text-align: left;
      }

      /* Estilo del JSON */
      /* Estilo Retro para el Output (Terminal) */
      #output {
        width: 100%;
        margin-top: 20px;
        color: #00ff00; /* Verde clásico de las terminales antiguas */
        padding: 20px;
        border-radius: 5px;
        border: 2px solid #14121b; /* Borde verde */
        font-family: "Courier New", monospace;
        font-size: 1.1rem;
        line-height: 1.6;
        overflow-y: auto;
        max-height: 300px;
        box-shadow: 0 0 20px rgb(22 26 25);
        white-space: pre-wrap; /* Permite que el texto se ajuste correctamente */
        word-wrap: break-word; /* Evita que el texto se desborde */
        background: linear-gradient(90deg, #171717, #313131);
        text-align: left;
      }
      /* Personaliza el tamaño de la barra de desplazamiento */
      #output::-webkit-scrollbar {
        width: 12px; /* Ancho de la barra de desplazamiento */
        height: 12px; /* Altura de la barra horizontal */
      }

      /* Personaliza el fondo de la barra de desplazamiento */
      #output::-webkit-scrollbar-track {
        background: #201e1e; /* Color de fondo */
        border-radius: 10px; /* Bordes redondeados */
      }

      /* Personaliza el control deslizante (thumb) */
      #output::-webkit-scrollbar-thumb {
        background: #252525; /* Color del control deslizante */
        border-radius: 10px; /* Bordes redondeados */
        border: 2px solid #f1f1f1; /* Borde alrededor del thumb */
      }

      /* Personaliza el control deslizante cuando se pasa el mouse */
      #output::-webkit-scrollbar-thumb:hover {
        background: #141414; /* Color al hacer hover */
      }

      pre {
        margin: 0;
        line-height: 1.5;
      }

      .json-key {
        color: #f39c12; /* Color para claves */
      }

      .json-value {
        color: #27ae60; /* Color para valores */
      }

      .json-string {
        color: #e74c3c; /* Color para cadenas */
      }

      .json-number {
        color: #8e44ad; /* Color para números */
      }

      .json-boolean {
        color: #3498db; /* Color para booleanos */
      }

      .json-null {
        color: #95a5a6; /* Color para null */
      }

      .json-phone-number {
        color: #229e09; /* Color para números de teléfono */
      }

      /* Estilo de los botones */
      .copy-button {
        display: none;
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        font-size: 16px;
        cursor: pointer;
        border-radius: 4px;
        transition: background-color 0.3s;
      }

      .copy-button:hover {
        background-color: #45a049;
      }

      .copy-button.show {
        display: inline-block;
      }

      .blink-caret {
        animation: blink-caret 0.8s step-end infinite;
      }

      @keyframes blink-caret {
        from,
        to {
          border-color: transparent;
        }
        50% {
          border-color: #4e91f6;
        }
      }
      .titles {
        color: #f64e8e;
        font-family: "Rye", cursive;
        animation: infiniteslickereffect 1 step-end infinite;
      }
      @keyframes infiniteslickereffect {
        from,
        to {
          color: #4e91f6;
        }
        50% {
          color: #1e79e4;
        }
        60% {
          color: #4e91f6;
        }
        80% {
          color: #1e79e4;
        }
        100% {
          color: #4e91f6;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Generador de JSON</h1>
      <form id="form">
        <div class="form-group">
          <label for="field-name">Nombre del campo</label>
          <input type="text" id="field-name" placeholder="Ejemplo: name" />
        </div>
        <div class="form-group">
          <label for="field-type">Tipo de dato</label>
          <select id="field-type">
            <option value="str">Texto</option>
            <option value="int">Número entero</option>
            <option value="float">Número decimal</option>
            <option value="id">ID Autoincremental</option>
            <option value="uuid4">Uuid4 (ID Random)</option>
            <option value="email">Email</option>
            <option value="bool">Booleano</option>
            <option value="date">Fecha</option>
            <option value="address">Dirección</option>
            <option value="phone_number">Número de teléfono</option>
            <option value="text">Texto Random</option>
            <option value="url">Url Random</option>
          </select>
          <label for="preset-schemas">Esquemas Predefinidos</label>
          <select id="preset-schemas" onchange="loadPresetSchema()">
            <option value="">-- Ninguno --</option>
            <optgroup label="Predeterminados">
              <option value="userWithUUID4">Usuario con UUID4</option>
              <option value="user">Usuario</option>
              <option value="product">Producto</option>
              <option value="order">Pedido</option>
              <option value="employee">Empleado</option>
            </optgroup>
            <optgroup label="Tus esquemas (Prosimamnte)" id="user-schemas-group"></optgroup>
          </select>
        </div>
        <button type="button" onclick="addField()">Añadir Campo</button>
        <div class="field-list" id="field-list">
          <p>No hay campos definidos.</p>
        </div>
        <div class="form-group">
          <label for="num-entries">Número de entradas</label>
          <input type="number" id="num-entries" max="1000" min="0" placeholder="Ejemplo: 10" />
        </div>
        <div class="form-group">
          <label for="typing-speed">Velocidad de escritura (ms por carácter)</label>
          <input type="number" id="typing-speed" placeholder="Ejemplo: 50" value="50" />
        </div>
        <div class="butons-actions-container">
          <button type="button" class="butons-actions" id="generateBtn">Generar</button>
          <button type="button" class="butons-actions" id="downloadBtn">Descargar JSON</button>
          <button type="button" class="butons-actions" onclick="saveSchema()">Guardar Esquema</button>
          <button type="button" class="butons-actions" onclick="loadSchema()">Cargar Esquema</button>
          <button type="button" class="butons-actions" onclick="viewHistory()">Ver Historial</button>
        </div>
      </form>
      <div id="output">
        <h1 class="titles">By JsonGenerator __________________________</h1>
      </div>
      <button type="button" class="butons-actions" id="stopBtn">Detener</button>
      <button type="button" class="butons-actions" id="resumeBtn">Reanudar</button>
      <button type="button" class="butons-actions" id="clearBtn">Limpiar</button>
      <button id="copyButton" class="copy-button">Copiar JSON</button>
      <div id="history"></div>
    </div>

    <script>
      const fields = [];
      const history = [];
      let generatedJSON = null; // Variable para almacenar el JSON generado

      function addField() {
        console.log("Añadiendo campo...");
        const fieldName = document.getElementById("field-name").value.trim();
        const fieldType = document.getElementById("field-type").value;

        if (!fieldName) {
          alert("Por favor, ingresa un nombre para el campo.");
          return;
        }

        if (fields.some((field) => field.name === fieldName)) {
          alert("El nombre del campo ya existe. Por favor, elige otro nombre.");
          return;
        }

        fields.push({ name: fieldName, type: fieldType });
        console.log("Campo añadido:", { name: fieldName, type: fieldType });
        updateFieldList();
        document.getElementById("field-name").value = ""; // Limpiar input
      }

      function updateFieldList() {
        console.log("Actualizando lista de campos...");
        const fieldList = document.getElementById("field-list");
        if (fields.length === 0) {
          fieldList.innerHTML = "<p>No hay campos definidos.</p>";
          return;
        }

        fieldList.innerHTML = fields
          .map(
            (field, index) => `
                <div class="field-item">
                    <span>${field.name} (${field.type})</span>
                    <button onclick="removeField(${index})">Eliminar</button>
                </div>`
          )
          .join("");
      }

      function removeField(index) {
        console.log("Eliminando campo en índice:", index);
        fields.splice(index, 1);
        updateFieldList();
      }

      function saveSchema() {
        const schemaName = prompt("Ingrese un nombre para el esquema:");
        if (schemaName) {
          localStorage.setItem(`user-schema-${schemaName}`, JSON.stringify(fields));
          alert("Esquema guardado.");
          updateUserSchemasList();
        }
      }
      function updateUserSchemasList() {
        const userSchemasGroup = document.getElementById("user-schemas-group");
        userSchemasGroup.innerHTML = ""; // Limpiar opciones anteriores

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith("user-schema-")) {
            const schemaName = key.replace("user-schema-", "");
            const option = document.createElement("option");
            option.value = key; // Usar el nombre de la clave como valor
            option.textContent = schemaName;
            userSchemasGroup.appendChild(option);
          }
        }
      }
      document.addEventListener("DOMContentLoaded", updateUserSchemasList);

      function loadSchema() {
        const schemaName = prompt("Ingrese el nombre del esquema a cargar:");
        const schema = localStorage.getItem(schemaName);
        if (schema) {
          fields.length = 0;
          fields.push(...JSON.parse(schema));
          updateFieldList();
          alert("Esquema cargado.");
        } else {
          alert("Esquema no encontrado.");
        }
      }
      let isGenerating = false; // Flag para controlar la generación
      let typingTimeout; // Variable para almacenar el timeout de la escritura
      // Botón Detener
      document.getElementById("stopBtn").addEventListener("click", function () {
        isGenerating = false; // Detenemos la generación
        clearTimeout(typingTimeout); // Detenemos el timeout de la animación de escritura
        console.log("Generación detenida.");
      });

      // Botón Reanudar
      document.getElementById("resumeBtn").addEventListener("click", function () {
        if (!isGenerating && generatedJSON) {
          isGenerating = true;
          displayJSONWithAnimation(generatedJSON, document.getElementById("typing-speed").value || 50);
          console.log("Generación reanudada.");
        } else {
          alert("Primero genera el JSON.");
        }
      });
      // Botón Limpiar
      document.getElementById("clearBtn").addEventListener("click", function () {
        document.getElementById("output").innerHTML = ""; // Limpiar la salida
        document.getElementById("history").innerHTML = ""; // Limpiar historial
        generatedJSON = null; // Limpiar el JSON generado

        console.log("Contenido limpiado.");
      });

      async function generateJSON() {
        isGenerating = true; // Come

        if (isGenerating) {
          const confirmRestart = confirm(
            "Ya se está generando un JSON. ¿Deseas detener la generación actual y comenzar una nueva?"
          );
          if (!confirmRestart) {
            return; // Si el usuario no confirma, no hacemos nada
          }

          // Detener la generación actual
          isGenerating = false;
          clearTimeout(typingTimeout); // Detener cualquier animación en curso
          document.getElementById("output").innerHTML = ""; // Limpiar la salida actual
        }

        console.log("Generando JSON...");

        // Limpiar el historial y el área de salida antes de generar un nuevo JSON
        document.getElementById("output").innerHTML = ""; // Limpiar la salida
        document.getElementById("history").innerHTML = ""; // Limpiar historial
        generatedJSON = null; // Limpiar el JSON anterior

        const numEntries = document.getElementById("num-entries").value || 10;
        const typingSpeed = document.getElementById("typing-speed").value || 50;

        if (fields.length === 0) {
          alert("Por favor, define al menos un campo.");
          return;
        }

        const requestData = {
          schema: fields,
          num_entries: parseInt(numEntries),
        };
        console.log("Datos enviados:", requestData);

        try {
          const response = await fetch("https://sever2-5koy.onrender.com/generate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData),
          });

          // Comprobamos si el servidor devuelve un error 400 específico
          if (!response.ok) {
            if (response.status === 400) {
              const errorData = await response.json();
              if (errorData.error && errorData.error.includes("Número de entradas excesivo")) {
                document.getElementById("output").innerHTML = `<p style="color: red;">${errorData.error}</p>
        <p style="color: red;">Por favor, reduce el número de entradas.</p>
        <p style="color: red;">El límite actual es de 1000 entradas.</p>`;
                return;
              }
            }
            throw new Error("Error al generar JSON");
          }

          const data = await response.json();
          console.log("JSON generado:", data);
          displayJSONWithAnimation(data, typingSpeed);

          // Almacenar el JSON generado y agregarlo al historial
          generatedJSON = data;
          history.push(data); // Agregar al historial
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("output").innerHTML = `<p style="color: red;">${error.message}</p>`;
          isGenerating = false;
        }
      }
      async function copyToClipboard() {
        const outputElement = document.getElementById("output");
        const jsonText = outputElement.textContent;
        try {
          await navigator.clipboard.writeText(jsonText);
          alert("JSON copiado al portapapeles");
        } catch (err) {
          console.error("Error al copiar:", err);
          alert("Error al copiar el JSON");
        }
      }

      function syntaxHighlight(json) {
        json = json.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        return json.replace(
          /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:\s*)?|true|false|null|-?\d+(\.\d*)?([eE][+-]?\d+)?)/g,
          function (match) {
            let cls = "json-value";

            // Si el valor es una clave (key), aplica la clase json-key
            if (/^"/.test(match) && /:/.test(match)) {
              cls = "json-key"; // Se aplica a la clave (key) de un objeto
            }
            // Si el valor es una cadena de texto (string), aplica la clase json-string
            else if (/^"/.test(match)) {
              cls = "json-string"; // Se aplica a los valores tipo string
            }
            // Si es un valor booleano (true/false), aplica la clase json-boolean
            else if (/true|false/.test(match)) {
              cls = "json-boolean"; // Se aplica a los valores booleanos
            }
            // Si es un valor null, aplica la clase json-null
            else if (/null/.test(match)) {
              cls = "json-null"; // Se aplica a los valores null
            }
            // Si es un número, aplica la clase json-number
            else if (/-?\d+(\.\d*)?([eE][+-]?\d+)?/.test(match)) {
              cls = "json-number"; // Se aplica a los números
            }
            // Si es un valor de tipo phone_number, aplica la clase json-phone-number
            else if (/^"((\d{3}\.|\(\d{3}\)|\d{3}-)\d{3}[-\.]\d{4}(x\d+)?|001-\d{3}-\d{3}-\d{4}x\d+)"$/.test(match)) {
              cls = "json-phone-number"; // Se aplica a los valores tipo phone_number
            }

            return `<span class="${cls}">${match}</span>`;
          }
        );
      }

      let index = 0; // Índice de la animación que se guardará

      function displayJSONWithAnimation(data, typingSpeed) {
        const outputElement = document.getElementById("output");
        const jsonString = JSON.stringify(data, null, 4);
        const highlightedJSON = syntaxHighlight(jsonString);

        // Si no está generando, comenzamos la animación desde el índice guardado
        if (!isGenerating) {
          isGenerating = true;
          typeNextChar(highlightedJSON, outputElement, typingSpeed);
        } else {
          // Si ya está generando, reanudamos desde el índice guardado
          typeNextChar(highlightedJSON, outputElement, typingSpeed);
        }

        function typeNextChar(highlightedJSON, outputElement, typingSpeed) {
          if (!isGenerating) return; // Si la generación está detenida, dejamos de escribir
          if (index < highlightedJSON.length) {
            outputElement.innerHTML = `<pre class="typing-animation">${highlightedJSON.slice(
              0,
              index + 1
            )}<span class="cursor">|</span></pre>`;
            index++;
            setTimeout(() => typeNextChar(highlightedJSON, outputElement, typingSpeed), typingSpeed); // Ajustar el tiempo para la velocidad de escritura

            // Desplazar hacia abajo en la vista
            outputElement.scrollTop = outputElement.scrollHeight;
          } else {
            outputElement.innerHTML = `<pre>${highlightedJSON}</pre>`; // Eliminar el cursor al finalizar
            copyButton.classList.add("show"); // Mostrar el botón de copiar cuando termine de mostrar el JSON
          }
        }
      }

      // Función para manejar el botón de generación y pausa
      function toggleGenerate() {
        if (isGenerating) {
          isGenerating = false; // Detener la animación
        } else {
          // Reanudar desde el índice guardado
          isGenerating = true;
          typeNextChar(highlightedJSON, outputElement, typingSpeed);
        }
      }

      function viewHistory() {
        const historyContainer = document.getElementById("history");

        if (history.length === 0) {
          historyContainer.innerHTML = "<p>No hay historial.</p>";
          return;
        }

        historyContainer.innerHTML = history
          .map((item) => {
            // Aplicamos el resaltado de sintaxis al JSON generado en el historial
            const highlightedJson = syntaxHighlight(JSON.stringify(item, null, 2));
            return `<div class="history-item">
                <pre>${highlightedJson}</pre>
              </div>`;
          })
          .join("");
      }

      document.getElementById("copyButton").addEventListener("click", copyToClipboard);

      // Evento para el botón de descarga
      document.getElementById("downloadBtn").addEventListener("click", function () {
        if (generatedJSON) {
          const blob = new Blob([JSON.stringify(generatedJSON, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "datos.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } else {
          alert("Primero debes generar el JSON");
        }
      });

      document.getElementById("generateBtn").addEventListener("click", function () {
        generateJSON();
      });

      function handleTypeChange() {
        const fieldType = document.getElementById("field-type").value;
        const fieldName = document.getElementById("field-name");

        if (fieldType === "id") {
          fieldName.value = "id";
          fieldName.disabled = true;
        } else {
          fieldName.disabled = false;
          fieldName.value = "";
        }
      }

      document.getElementById("downloadBtn").addEventListener("click", function (event) {
        // Prevenir que el evento se propague
        event.stopPropagation();

        if (generatedJSON) {
          // Creamos un Blob para generar el archivo
          const blob = new Blob([JSON.stringify(generatedJSON, null, 2)], { type: "application/json" });
          const url = URL.createObjectURL(blob);

          // Creamos un enlace solo una vez y lo usamos
          const a = document.createElement("a");
          a.href = url;
          a.download = "datos.json";
          document.body.appendChild(a);
          a.click();

          // Limpiamos después de la descarga
          document.body.removeChild(a);
          URL.revokeObjectURL(url); // Liberamos el objeto URL
        } else {
          alert("Primero debes generar el JSON");
        }
      });

      const presetSchemas = {
        user: [
          { name: "id", type: "id" },
          { name: "username", type: "str" },
          { name: "email", type: "email" },
          { name: "active", type: "bool" },
          { name: "created_at", type: "date" },
          { name: "info", type: "text" },
        ],

        userWithUUID4: [
          { name: "id", type: "uuid4" },
          { name: "username", type: "str" },
          { name: "email", type: "email" },
          { name: "active", type: "bool" },
          { name: "created_at", type: "date" },
          { name: "info", type: "text" },
        ],

        product: [
          { name: "id", type: "id" },
          { name: "name", type: "str" },
          { name: "price", type: "float" },
          { name: "stock", type: "int" },
          { name: "available", type: "bool" },
        ],
        order: [
          { name: "id", type: "id" },
          { name: "customer_name", type: "str" },
          { name: "amount", type: "float" },
          { name: "address", type: "address" },
          { name: "phone", type: "phone_number" },
          { name: "date", type: "date" },
        ],
        employee: [
          { name: "id", type: "id" },
          { name: "full_name", type: "str" },
          { name: "email", type: "email" },
          { name: "phone", type: "phone_number" },
          { name: "hire_date", type: "date" },
          { name: "active", type: "bool" },
          { name: "info", type: "text" },
        ],
      };
      function loadPresetSchema() {
        const select = document.getElementById("preset-schemas");
        const selectedSchema = select.value;

        // Limpiar campos actuales
        fields.length = 0;

        if (presetSchemas[selectedSchema]) {
          // Cargar el esquema predefinido
          fields.push(...presetSchemas[selectedSchema]);
        } else {
          console.warn("Esquema no encontrado o ninguno seleccionado.");
        }

        updateFieldList();
      }
    </script>
  </body>
</html>
