<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="/jsonfavicon.ico" type="image/x-ico" />
    <title>Generar y Descargar JSON</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        /* Tema claro (default) */
        --bg-primary: linear-gradient(135deg, #f6f8fd 0%, #f1f4f9 100%);
        --bg-card: #ffffff;
        --text-primary: #2d3748;
        --text-secondary: #4a5568;
        --border-color: #e2e8f0;
        --input-bg: #f8fafc;
        --input-border: #e2e8f0;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.05),
          0 1px 3px rgba(0, 0, 0, 0.1);
        --output-bg: linear-gradient(45deg, #1a202c, #2d3748);
        --output-text: #a0aec0;
        --btn-text: #ffffff;
      }

      /* Tema oscuro */
      [data-theme='dark'] {
        --bg-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
        --bg-card: #2d3748;
        --text-primary: #171818;
        --text-secondaary: #cbd5e0;
        --border-color: #4a5568;
        --input-bg: #1a202c;
        --input-border: #4a5568;
        --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.2),
          0 1px 3px rgba(0, 0, 0, 0.3);
        --output-bg: linear-gradient(45deg, #0d1117, #1a202c);
        --output-text: #cbd5e0;
        --btn-text: #f7fafc;
      }

      /* Actualizar estilos específicos para el tema oscuro */
      [data-theme='dark'] .form-control,
      [data-theme='dark'] .form-select {
        background-color: var(--input-bg);
        border-color: var(--input-border);
        color: var(--text-primary);
      }

      [data-theme='dark'] .form-control:focus,
      [data-theme='dark'] .form-select:focus {
        border-color: #4e91f6;
        box-shadow: 0 0 0 3px rgba(78, 145, 246, 0.2);
      }

      [data-theme='dark'] .form-control option,
      [data-theme='dark'] .form-select option {
        background-color: var(--input-bg);
        color: var(--text-primary);
      }

      [data-theme='dark'] .btn-primary {
        color: var(--btn-text);
      }

      [data-theme='dark'] #output,
      [data-theme='dark'] #history {
        background: var(--output-bg);
        color: var(--output-text);
      }

      [data-theme='dark'] .history-item {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
      }

      [data-theme='dark'] h1 {
        background: linear-gradient(45deg, #60a5fa, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      [data-theme='dark'] .card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
      }

      [data-theme='dark'] .field-item {
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
      }

      [data-theme='dark'] .btn-outline-primary {
        color: #60a5fa;
        border-color: #60a5fa;
      }

      [data-theme='dark'] .btn-outline-primary:hover {
        background-color: #60a5fa;
        color: var(--btn-text);
      }

      /* Estilos generales que responden a las variables */
      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        margin: 0;
        transition: background 0.3s ease;
      }

      .card {
        background: var(--bg-card);
        color: var(--text-primary);
      }

      .form-label {
        color: var(--text-primary);
      }

      .form-control,
      .form-select {
        background-color: var(--input-bg);
        border-color: var(--input-border);
        color: var(--text-primary);
      }

      /* Asegurar que las transiciones sean suaves */
      * {
        transition: background-color 0.3s ease, color 0.3s ease,
          border-color 0.3s ease, box-shadow 0.3s ease;
      }

      /* Ajustes para el botón de tema */
      .theme-toggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        background: var(--bg-card);
        border: 2px solid var(--border-color);
        color: var(--text-primary);
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1000;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        box-shadow: var(--card-shadow);
      }

      .theme-toggle:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=JetBrains+Mono&display=swap');
      /* General */
      body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #f6f8fd 0%, #f1f4f9 100%);
        color: #2d3748;
        margin: 0;
        padding: 2rem 0;
        min-height: 100vh;
      }

      h1 {
        font-size: 2.5rem;
        color: #2d3748;
        font-weight: 600;
        text-align: center;
        margin-bottom: 2rem;
        background: linear-gradient(45deg, #4e91f6, #1e79e4);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .container {
        max-width: 1400px !important;
        margin: 0 auto;
      }

      /* Cards y Formularios */
      .card {
        background: #ffffff;
        border-radius: 1rem;
        border: none;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05), 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      }

      .form-control,
      .form-select {
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        padding: 0.75rem;
        font-size: 0.95rem;
        background-color: #f8fafc;
        transition: all 0.2s ease;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: #4e91f6;
        box-shadow: 0 0 0 3px rgba(78, 145, 246, 0.2);
        background-color: #ffffff;
      }

      /* Botones */
      .btn {
        border-radius: 0.5rem;
        padding: 0.75rem 1.5rem;
        font-weight: 500;
        transition: all 0.2s ease;
      }

      .btn-primary {
        background: linear-gradient(45deg, #4e91f6, #1e79e4);
        border: none;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(78, 145, 246, 0.3);
      }

      .btn-success {
        background: linear-gradient(45deg, #48bb78, #38a169);
        border: none;
      }

      .btn-danger {
        background: linear-gradient(45deg, #f56565, #e53e3e);
        border: none;
      }

      /* Lista de campos */
      .field-list {
        background: #f8fafc;
        border-radius: 0.8rem;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #e2e8f0;
      }

      .field-item {
        background: #ffffff;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease;
      }

      .field-item:hover {
        transform: translateX(2px);
      }

      /* Output y Terminal */
      #output,
      #history {
        background: linear-gradient(45deg, #1a202c, #2d3748);
        color: #a0aec0;
        font-family: 'JetBrains Mono', monospace;
        padding: 1.5rem;
        border-radius: 0.8rem;
        line-height: 1.6;
        font-size: 0.9rem;
      }

      /* Colores de sintaxis JSON */
      .json-key {
        color: #f6ad55;
      }
      .json-string {
        color: #68d391;
      }
      .json-number {
        color: #63b3ed;
      }
      .json-boolean {
        color: #f687b3;
      }
      .json-null {
        color: #cbd5e0;
      }

      /* Scrollbar personalizada */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f4f9;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
      }

      /* Esquemas predefinidos */
      #preset-schemas {
        background-color: #f8fafc;
        border-color: #e2e8f0;
        font-size: 0.95rem;
      }

      #preset-schemas optgroup {
        font-weight: 600;
        color: #4a5568;
      }

      #preset-schemas option {
        padding: 0.5rem;
        font-weight: normal;
      }

      /* Loading Spinner */
      .loading-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        justify-content: center;
        align-items: center;
        background: rgba(45, 55, 72, 0.9);
        backdrop-filter: blur(4px);
        z-index: 1000;
      }

      .loading-spinner {
        font-size: 2rem;
        color: #4e91f6;
        margin-right: 1rem;
      }

      .loading-text {
        color: #ffffff;
        font-weight: 500;
        font-size: 1.1rem;
      }

      /* Historial */
      .history-container {
        margin-top: 3rem;
        padding: 2rem;
        background: #ffffff;
        border-radius: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .history-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e2e8f0;
      }

      .history-header h4 {
        color: #2d3748;
        font-weight: 600;
      }

      .history-item {
        background: #f8fafc;
        border-radius: 0.8rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.2s ease;
      }

      .history-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      .history-content {
        background: linear-gradient(45deg, #1a202c, #2d3748);
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin: 1rem 0;
        font-family: 'JetBrains Mono', monospace;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .container {
          padding: 1rem;
        }

        h1 {
          font-size: 2rem;
        }

        .card {
          margin-bottom: 1.5rem;
        }

        .btn {
          width: 100%;
          margin-bottom: 0.5rem;
        }
      }

      /* Corregir el fondo del body */
      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        margin: 0;
        transition: background 0.3s ease;
      }

      /* Corregir los options en modo oscuro */
      [data-theme='dark'] .form-select option {
        background-color: var(--bg-card);
        color: var(--text-primary);
      }

      /* Asegurar que el fondo se aplique también al html */
      html {
        background: var(--bg-primary);
        min-height: 100vh;
      }

      /* Corregir el contraste en los selects */
      .form-select {
        background-color: var(--input-bg);
        color: var(--text-primary);
        border-color: var(--input-border);
      }

      /* Asegurar que los options tengan el color correcto en ambos temas */
      .form-select option {
        background-color: var(--bg-card);
        color: var(--text-primary);
        padding: 8px;
      }

      /* Estilo específico para los options en modo oscuro */
      [data-theme='dark'] select option {
        background-color: #2d3748;
        color: #f7fafc;
      }

      /* Estilo específico para los options en modo claro */
      select option {
        background-color: #ffffff;
        color: #2d3748;
      }
    </style>
  </head>
  <body>
    <button class="theme-toggle" id="themeToggle">
      <i class="fas fa-sun"></i>
      <span>Cambiar tema</span>
    </button>

    <div class="loading-container" id="loadingSpinner">
      <i class="fas fa-spinner fa-spin loading-spinner"></i>
      <span class="loading-text">Generando JSON...</span>
    </div>

    <div class="container">
      <h1 class="text-center mb-4">Generador de JSON</h1>

      <div class="row">
        <div class="col-md-6">
          <div class="card p-4">
            <form id="form">
              <div class="mb-3">
                <label class="form-label">Nombre del campo</label>
                <input
                  type="text"
                  class="form-control"
                  id="field-name"
                  placeholder="Ejemplo: name"
                />
              </div>

              <div class="mb-3">
                <label class="form-label">Tipo de dato</label>
                <select class="form-select" id="field-type">
                  <option value="str">Texto</option>
                  <option value="int">Número entero</option>
                  <option value="float">Número decimal</option>
                  <option value="id">ID Autoincremental</option>
                  <option value="uuid4">Uuid4 (ID Random)</option>
                  <option value="email">Email</option>
                  <option value="bool">Booleano</option>
                  <option value="date">Fecha</option>
                  <option value="address">Dirección</option>
                  <option value="phone_number">Número de teléfono</option>
                  <option value="text">Texto Random</option>
                  <option value="url">Url Random</option>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">Esquemas Predefinidos</label>
                <select class="form-select" id="preset-schemas">
                  <option value="">-- Ninguno --</option>
                  <optgroup
                    label="Mis Esquemas Guardados"
                    id="user-schemas-group"
                  >
                    <!-- Aquí se cargarán los esquemas guardados -->
                  </optgroup>
                  <optgroup label="Predeterminados">
                    <option value="userWithUUID4">Usuario con UUID4</option>
                    <option value="user">Usuario</option>
                    <option value="product">Producto</option>
                    <option value="order">Pedido</option>
                    <option value="employee">Empleado</option>
                  </optgroup>
                </select>
              </div>

              <div class="d-flex gap-2 mb-3">
                <button
                  type="button"
                  class="btn btn-success"
                  onclick="saveCurrentSchema()"
                >
                  <i class="fas fa-save me-2"></i>Guardar Esquema Actual
                </button>
                <button
                  type="button"
                  class="btn btn-danger"
                  onclick="deleteSelectedSchema()"
                >
                  <i class="fas fa-trash me-2"></i>Eliminar Esquema
                </button>
              </div>

              <button
                type="button"
                class="btn btn-primary w-100 mb-3"
                onclick="addField()"
              >
                <i class="fas fa-plus-circle me-2"></i>Añadir Campo
              </button>

              <div class="field-list mb-3" id="field-list">
                <!-- campos se agregarán dinámicamente -->
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Número de entradas</label>
                  <input type="number" class="form-control" id="num-entries" />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Velocidad de escritura</label>
                  <input type="number" class="form-control" id="typing-speed" />
                </div>
              </div>

              <div class="d-grid gap-2">
                <button type="button" class="btn btn-primary" id="generateBtn">
                  <i class="fas fa-cog me-2"></i>Generar
                </button>
                <button type="button" class="btn btn-success" id="downloadBtn">
                  <i class="fas fa-download me-2"></i>Descargar JSON
                </button>
                <button type="button" class="btn btn-info" id="showHistoryBtn">
                  <i class="fas fa-history me-2"></i>Mostrar Historial
                </button>
              </div>
            </form>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card p-4">
            <div id="output" class="mb-3"></div>

            <div class="btn-group mb-3">
              <button type="button" class="btn btn-secondary" id="stopBtn">
                <i class="fas fa-pause me-2"></i>Detener
              </button>
              <button type="button" class="btn btn-secondary" id="resumeBtn">
                <i class="fas fa-play me-2"></i>Reanudar
              </button>
              <button type="button" class="btn btn-secondary" id="clearBtn">
                <i class="fas fa-trash me-2"></i>Limpiar
              </button>
            </div>

            <button id="copyButton" class="btn btn-outline-primary">
              <i class="fas fa-clipboard me-2"></i>Copiar JSON
            </button>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <h3>Historial</h3>
        <div id="history"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>

    <script>
      const fields = [];
      let jsonHistory = [];
      let generatedJSON = null; // Variable para almacenar el JSON generado

      // Constantes para el localStorage
      const HISTORY_STORAGE_KEY = 'jsonGeneratorHistory';
      const USER_SCHEMAS_KEY = 'userSchemas';

      // Eliminar la palabra 'let' ya que jsonHistory ya está declarado arriba
      jsonHistory = [];
      try {
        const savedHistory = localStorage.getItem(HISTORY_STORAGE_KEY);
        if (savedHistory) {
          jsonHistory = JSON.parse(savedHistory);
          if (jsonHistory.length > 0) {
            viewHistory();
          }
        }
      } catch (error) {
        console.error('Error al cargar el historial:', error);
        jsonHistory = [];
      }

      // Función para guardar en localStorage
      function saveHistoryToStorage() {
        try {
          localStorage.setItem(
            HISTORY_STORAGE_KEY,
            JSON.stringify(jsonHistory)
          );
        } catch (error) {
          console.error('Error al guardar el historial:', error);
          // Si el localStorage está lleno, eliminar las entradas más antiguas
          if (error.name === 'QuotaExceededError') {
            while (jsonHistory.length > 0) {
              jsonHistory.pop(); // Eliminar la última entrada
              try {
                localStorage.setItem(
                  HISTORY_STORAGE_KEY,
                  JSON.stringify(jsonHistory)
                );
                break;
              } catch (e) {
                continue;
              }
            }
          }
        }
      }

      function addField() {
        console.log('Añadiendo campo...');
        const fieldName = document.getElementById('field-name').value.trim();
        const fieldType = document.getElementById('field-type').value;

        if (!fieldName) {
          alert('Por favor, ingresa un nombre para el campo.');
          return;
        }

        if (fields.some((field) => field.name === fieldName)) {
          alert('El nombre del campo ya existe. Por favor, elige otro nombre.');
          return;
        }

        fields.push({ name: fieldName, type: fieldType });
        console.log('Campo añadido:', { name: fieldName, type: fieldType });
        updateFieldList();
        document.getElementById('field-name').value = ''; // Limpiar input
      }

      function updateFieldList() {
        console.log('Actualizando lista de campos...');
        const fieldList = document.getElementById('field-list');
        if (fields.length === 0) {
          fieldList.innerHTML = '<p>No hay campos definidos.</p>';
          return;
        }

        fieldList.innerHTML = fields
          .map(
            (field, index) => `
                <div class="field-item">
                    <span>${field.name} (${field.type})</span>
                    <button onclick="removeField(${index})">Eliminar</button>
                </div>`
          )
          .join('');
      }

      function removeField(index) {
        console.log('Eliminando campo en índice:', index);
        fields.splice(index, 1);
        updateFieldList();
      }

      function saveSchema() {
        const schemaName = prompt('Ingrese un nombre para el esquema:');
        if (schemaName) {
          localStorage.setItem(
            `user-schema-${schemaName}`,
            JSON.stringify(fields)
          );
          alert('Esquema guardado.');
          updateUserSchemasList();
        }
      }
      function updateUserSchemasList() {
        const userSchemasGroup = document.getElementById('user-schemas-group');
        userSchemasGroup.innerHTML = ''; // Limpiar opciones anteriores

        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('user-schema-')) {
            const schemaName = key.replace('user-schema-', '');
            const option = document.createElement('option');
            option.value = key; // Usar el nombre de la clave como valor
            option.textContent = schemaName;
            userSchemasGroup.appendChild(option);
          }
        }
      }
      document.addEventListener('DOMContentLoaded', updateUserSchemasList);

      function loadSchema() {
        const schemaName = prompt('Ingrese el nombre del esquema a cargar:');
        const schema = localStorage.getItem(schemaName);
        if (schema) {
          fields.length = 0;
          fields.push(...JSON.parse(schema));
          updateFieldList();
          alert('Esquema cargado.');
        } else {
          alert('Esquema no encontrado.');
        }
      }
      let isGenerating = false; // Flag para controlar la generación
      let typingTimeout; // Variable para almacenar el timeout de la escritura
      // Botón Detener
      document.getElementById('stopBtn').addEventListener('click', function () {
        isGenerating = false; // Detenemos la generación
        clearTimeout(typingTimeout); // Detenemos el timeout de la animación de escritura
        console.log('Generación detenida.');
      });

      // Botón Reanudar
      document
        .getElementById('resumeBtn')
        .addEventListener('click', function () {
          if (!isGenerating && generatedJSON) {
            isGenerating = true;
            displayJSONWithAnimation(
              generatedJSON,
              document.getElementById('typing-speed').value || 50
            );
            console.log('Generación reanudada.');
          } else {
            alert('Primero genera el JSON.');
          }
        });
      // Botón Limpiar
      document
        .getElementById('clearBtn')
        .addEventListener('click', function () {
          document.getElementById('output').innerHTML = ''; // Limpiar la salida
          document.getElementById('history').innerHTML = ''; // Limpiar historial
          generatedJSON = null; // Limpiar el JSON generado

          console.log('Contenido limpiado.');
        });

      async function generateJSON() {
        document.getElementById('loadingSpinner').style.display = 'flex';

        try {
          isGenerating = false;
          clearTimeout(typingTimeout);

          const numEntries = document.getElementById('num-entries').value || 10;
          const typingSpeed =
            document.getElementById('typing-speed').value || 50;

          if (fields.length === 0) {
            alert('Por favor, define al menos un campo.');
            return;
          }

          const requestData = {
            schema: fields,
            num_entries: parseInt(numEntries),
          };

          const response = await fetch(
            'https://sever2-5koy.onrender.com/generate',
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(requestData),
            }
          );

          if (!response.ok) {
            throw new Error('Error al generar JSON');
          }

          const data = await response.json();
          generatedJSON = data;

          // Iniciar la animación (el historial se añadirá cuando termine)
          displayJSONWithAnimation(data, typingSpeed);
        } catch (error) {
          console.error('Error:', error);
          document.getElementById(
            'output'
          ).innerHTML = `<p style="color: red;">${error.message}</p>`;
        } finally {
          document.getElementById('loadingSpinner').style.display = 'none';
        }
      }

      async function copyToClipboard() {
        const outputElement = document.getElementById('output');
        const jsonText = outputElement.textContent;
        try {
          await navigator.clipboard.writeText(jsonText);
          alert('JSON copiado al portapapeles');
        } catch (err) {
          console.error('Error al copiar:', err);
          alert('Error al copiar el JSON');
        }
      }

      function syntaxHighlight(json) {
        json = json
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
        return json.replace(
          /("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:\s*)?|true|false|null|-?\d+(\.\d*)?([eE][+-]?\d+)?)/g,
          function (match) {
            let cls = 'json-value';

            // Si el valor es una clave (key), aplica la clase json-key
            if (/^"/.test(match) && /:/.test(match)) {
              cls = 'json-key'; // Se aplica a la clave (key) de un objeto
            }
            // Si el valor es una cadena de texto (string), aplica la clase json-string
            else if (/^"/.test(match)) {
              cls = 'json-string'; // Se aplica a los valores tipo string
            }
            // Si es un valor booleano (true/false), aplica la clase json-boolean
            else if (/true|false/.test(match)) {
              cls = 'json-boolean'; // Se aplica a los valores booleanos
            }
            // Si es un valor null, aplica la clase json-null
            else if (/null/.test(match)) {
              cls = 'json-null'; // Se aplica a los valores null
            }
            // Si es un número, aplica la clase json-number
            else if (/-?\d+(\.\d*)?([eE][+-]?\d+)?/.test(match)) {
              cls = 'json-number'; // Se aplica a los números
            }
            // Si es un valor de tipo phone_number, aplica la clase json-phone-number
            else if (
              /^"((\d{3}\.|\(\d{3}\)|\d{3}-)\d{3}[-\.]\d{4}(x\d+)?|001-\d{3}-\d{3}-\d{4}x\d+)"$/.test(
                match
              )
            ) {
              cls = 'json-phone-number'; // Se aplica a los valores tipo phone_number
            }

            return `<span class="${cls}">${match}</span>`;
          }
        );
      }

      let index = 0; // Índice de la animación que se guardará

      function displayJSONWithAnimation(data, typingSpeed) {
        const outputElement = document.getElementById('output');
        const jsonString = JSON.stringify(data, null, 4);
        const highlightedJSON = syntaxHighlight(jsonString);
        let index = 0;

        // Ocultar el botón de copiar al inicio de la animación
        document.getElementById('copyButton').style.display = 'none';

        // Limpiar cualquier timeout pendiente
        clearTimeout(typingTimeout);

        // Reiniciar el contenido
        outputElement.innerHTML = '';

        function typeNextChar() {
          if (!isGenerating) return; // Si la generación está detenida, dejamos de escribir

          if (index < highlightedJSON.length) {
            outputElement.innerHTML = `<pre class="typing-animation">${highlightedJSON.slice(
              0,
              index + 1
            )}<span class="cursor">|</span></pre>`;
            index++;
            typingTimeout = setTimeout(() => typeNextChar(), typingSpeed);

            // Desplazar hacia abajo en la vista
            outputElement.scrollTop = outputElement.scrollHeight;
          } else {
            // Cuando termine la animación:
            outputElement.innerHTML = `<pre>${highlightedJSON}</pre>`;

            // Mostrar el botón de copiar
            document.getElementById('copyButton').style.display = 'block';

            // Añadir al historial
            const historyEntry = {
              data: data,
              timestamp: new Date().toISOString(),
              schema: [...fields], // Guardar también el esquema usado
            };

            jsonHistory.unshift(historyEntry); // Agregar al inicio del array
            saveHistoryToStorage(); // Guardar en localStorage
            viewHistory(); // Actualizar vista del historial
          }
        }

        // Iniciar la animación
        isGenerating = true;
        typeNextChar();
      }

      // Función para manejar el botón de generación y pausa
      function toggleGenerate() {
        if (isGenerating) {
          isGenerating = false; // Detener la animación
        } else {
          // Reanudar desde el índice guardado
          isGenerating = true;
          typeNextChar(highlightedJSON, outputElement, typingSpeed);
        }
      }
      function viewHistory() {
        const historyContainer = document.getElementById('history');

        if (jsonHistory.length === 0) {
          historyContainer.innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              No hay historial de generaciones previas.
            </div>`;
          return;
        }

        const historyContent = jsonHistory
          .map((entry, index) => {
            const timestamp = new Date(entry.timestamp).toLocaleString();
            const highlightedJson = syntaxHighlight(
              JSON.stringify(entry.data, null, 2)
            );

            return `
            <div class="history-item mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="m-0">
                  <i class="fas fa-file-code me-2"></i>
                  Generación #${jsonHistory.length - index}
                </h5>
                <small class="text-muted">
                  <i class="fas fa-clock me-1"></i>
                  ${timestamp}
                </small>
              </div>
              <div class="history-content p-3 rounded" style="background: #1a1a1a;">
                <pre class="m-0">${highlightedJson}</pre>
              </div>
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-primary copy-history" data-index="${index}">
                  <i class="fas fa-copy me-1"></i>
                  Copiar
                </button>
                <button class="btn btn-sm btn-outline-success load-schema" data-index="${index}">
                  <i class="fas fa-upload me-1"></i>
                  Cargar Esquema
                </button>
                <button class="btn btn-sm btn-outline-danger delete-history" data-index="${index}">
                  <i class="fas fa-trash me-1"></i>
                  Eliminar
                </button>
              </div>
            </div>
            ${index < jsonHistory.length - 1 ? '<hr class="my-4">' : ''}
          `;
          })
          .join('');

        historyContainer.innerHTML = `
          <div class="history-header d-flex justify-content-between align-items-center mb-3">
            <h4><i class="fas fa-history me-2"></i>Historial de Generaciones</h4>
            <button class="btn btn-danger btn-sm" id="clearHistoryBtn">
              <i class="fas fa-trash-alt me-2"></i>
              Limpiar Historial
            </button>
          </div>
          <div class="history-list">
            ${historyContent}
          </div>
        `;

        // Event listeners para los botones
        document.querySelectorAll('.copy-history').forEach((button) => {
          button.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            const jsonText = JSON.stringify(jsonHistory[index].data, null, 2);
            navigator.clipboard.writeText(jsonText).then(() => {
              const originalText = this.innerHTML;
              this.innerHTML = '<i class="fas fa-check me-1"></i>Copiado!';
              this.classList.add('btn-success');
              setTimeout(() => {
                this.innerHTML = originalText;
                this.classList.remove('btn-success');
              }, 2000);
            });
          });
        });

        // Nuevo event listener para cargar esquema
        document.querySelectorAll('.load-schema').forEach((button) => {
          button.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            if (confirm('¿Deseas cargar el esquema de esta generación?')) {
              fields.length = 0;
              fields.push(...jsonHistory[index].schema);
              updateFieldList();
            }
          });
        });

        document.querySelectorAll('.delete-history').forEach((button) => {
          button.addEventListener('click', function () {
            const index = this.getAttribute('data-index');
            if (
              confirm(
                '¿Estás seguro de que deseas eliminar esta entrada del historial?'
              )
            ) {
              jsonHistory.splice(index, 1);
              saveHistoryToStorage(); // Guardar cambios
              viewHistory();
            }
          });
        });

        document
          .getElementById('clearHistoryBtn')
          ?.addEventListener('click', function () {
            if (
              confirm('¿Estás seguro de que deseas limpiar todo el historial?')
            ) {
              jsonHistory.length = 0;
              saveHistoryToStorage(); // Guardar cambios
              viewHistory();
            }
          });
      }

      document
        .getElementById('copyButton')
        .addEventListener('click', copyToClipboard);

      // Evento para el botón de descarga
      document
        .getElementById('downloadBtn')
        .addEventListener('click', function (event) {
          event.preventDefault();
          event.stopPropagation();

          if (generatedJSON) {
            // Creamos el Blob y la URL
            const blob = new Blob([JSON.stringify(generatedJSON, null, 2)], {
              type: 'application/json',
            });
            const url = URL.createObjectURL(blob);

            // Convertir el botón temporalmente en un enlace de descarga
            const downloadBtn = this;
            downloadBtn.href = url;
            downloadBtn.download = 'datos.json';

            // Limpiar después de la descarga
            setTimeout(() => {
              URL.revokeObjectURL(url);
              downloadBtn.href = '#';
              downloadBtn.removeAttribute('download');
            }, 100);
          } else {
            alert('Primero debes generar el JSON');
          }
        });

      document
        .getElementById('generateBtn')
        .addEventListener('click', function () {
          generateJSON();
        });

      function handleTypeChange() {
        const fieldType = document.getElementById('field-type').value;
        const fieldName = document.getElementById('field-name');

        if (fieldType === 'id') {
          fieldName.value = 'id';
          fieldName.disabled = true;
        } else {
          fieldName.disabled = false;
          fieldName.value = '';
        }
      }

      document
        .getElementById('downloadBtn')
        .addEventListener('click', function (event) {
          // Prevenir que el evento se propague
          event.stopPropagation();

          if (generatedJSON) {
            // Creamos un Blob para generar el archivo
            const blob = new Blob([JSON.stringify(generatedJSON, null, 2)], {
              type: 'application/json',
            });
            const url = URL.createObjectURL(blob);

            // Creamos un enlace solo una vez y lo usamos
            const a = document.createElement('a');
            a.href = url;
            a.download = 'datos.json';
            document.body.appendChild(a);
            a.click();

            // Limpiamos después de la descarga
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Liberamos el objeto URL
          } else {
            alert('Primero debes generar el JSON');
          }
        });

      const presetSchemas = {
        user: [
          { name: 'id', type: 'id' },
          { name: 'username', type: 'str' },
          { name: 'email', type: 'email' },
          { name: 'active', type: 'bool' },
          { name: 'created_at', type: 'date' },
          { name: 'info', type: 'text' },
        ],

        userWithUUID4: [
          { name: 'id', type: 'uuid4' },
          { name: 'username', type: 'str' },
          { name: 'email', type: 'email' },
          { name: 'active', type: 'bool' },
          { name: 'created_at', type: 'date' },
          { name: 'info', type: 'text' },
        ],

        product: [
          { name: 'id', type: 'id' },
          { name: 'name', type: 'str' },
          { name: 'price', type: 'float' },
          { name: 'stock', type: 'int' },
          { name: 'available', type: 'bool' },
        ],
        order: [
          { name: 'id', type: 'id' },
          { name: 'customer_name', type: 'str' },
          { name: 'amount', type: 'float' },
          { name: 'address', type: 'address' },
          { name: 'phone', type: 'phone_number' },
          { name: 'date', type: 'date' },
        ],
        employee: [
          { name: 'id', type: 'id' },
          { name: 'full_name', type: 'str' },
          { name: 'email', type: 'email' },
          { name: 'phone', type: 'phone_number' },
          { name: 'hire_date', type: 'date' },
          { name: 'active', type: 'bool' },
          { name: 'info', type: 'text' },
        ],
      };
      function loadPresetSchema() {
        const select = document.getElementById('preset-schemas');
        const selectedSchema = select.value;

        // Limpiar campos actuales
        fields.length = 0;

        // Primero buscar en esquemas de usuario
        const userSchemas = JSON.parse(
          localStorage.getItem(USER_SCHEMAS_KEY) || '{}'
        );
        if (userSchemas[selectedSchema]) {
          fields.push(...userSchemas[selectedSchema]);
        }
        // Si no se encuentra, buscar en esquemas predefinidos
        else if (presetSchemas[selectedSchema]) {
          fields.push(...presetSchemas[selectedSchema]);
        }

        updateFieldList();
      }

      document
        .getElementById('preset-schemas')
        .addEventListener('change', function () {
          const select = document.getElementById('preset-schemas');
          const selectedSchema = select.value;

          // Limpiar campos actuales
          fields.length = 0;

          if (selectedSchema && presetSchemas[selectedSchema]) {
            // Cargar el esquema predefinido
            fields.push(...presetSchemas[selectedSchema]);
            console.log('Esquema cargado:', selectedSchema);
          } else {
            console.log('Ningún esquema seleccionado o esquema no encontrado');
          }

          updateFieldList();
        });

      // Agregar el event listener para el botón de mostrar historial
      document
        .getElementById('showHistoryBtn')
        .addEventListener('click', function () {
          const historySection = document.getElementById('history');
          if (historySection.style.display === 'none') {
            historySection.style.display = 'block';
            this.innerHTML =
              '<i class="fas fa-times me-2"></i>Ocultar Historial';
            viewHistory();
          } else {
            historySection.style.display = 'none';
            this.innerHTML =
              '<i class="fas fa-history me-2"></i>Mostrar Historial';
          }
        });

      // Función para guardar el esquema actual
      function saveCurrentSchema() {
        if (fields.length === 0) {
          alert('No hay campos definidos para guardar');
          return;
        }

        const schemaName = prompt('Ingrese un nombre para el esquema:');
        if (!schemaName) return;

        // Obtener esquemas existentes
        let userSchemas = JSON.parse(
          localStorage.getItem(USER_SCHEMAS_KEY) || '{}'
        );

        // Guardar el nuevo esquema
        userSchemas[schemaName] = fields;
        localStorage.setItem(USER_SCHEMAS_KEY, JSON.stringify(userSchemas));

        // Actualizar la lista de esquemas
        updateUserSchemasList();
        alert('Esquema guardado exitosamente');
      }

      // Función para eliminar un esquema guardado
      function deleteSelectedSchema() {
        const select = document.getElementById('preset-schemas');
        const selectedSchema = select.value;
        const userSchemas = JSON.parse(
          localStorage.getItem(USER_SCHEMAS_KEY) || '{}'
        );

        if (userSchemas[selectedSchema]) {
          if (
            confirm(`¿Estás seguro de eliminar el esquema "${selectedSchema}"?`)
          ) {
            delete userSchemas[selectedSchema];
            localStorage.setItem(USER_SCHEMAS_KEY, JSON.stringify(userSchemas));
            updateUserSchemasList();
            alert('Esquema eliminado exitosamente');
          }
        } else {
          alert('No se puede eliminar un esquema predeterminado');
        }
      }

      // Función para actualizar la lista de esquemas en el select
      function updateUserSchemasList() {
        const userSchemasGroup = document.getElementById('user-schemas-group');
        userSchemasGroup.innerHTML = ''; // Limpiar opciones existentes

        const userSchemas = JSON.parse(
          localStorage.getItem(USER_SCHEMAS_KEY) || '{}'
        );

        // Agregar cada esquema guardado como una opción
        Object.keys(userSchemas).forEach((schemaName) => {
          const option = document.createElement('option');
          option.value = schemaName;
          option.textContent = schemaName;
          userSchemasGroup.appendChild(option);
        });
      }

      // Cargar esquemas guardados al iniciar
      document.addEventListener('DOMContentLoaded', () => {
        updateUserSchemasList();

        // Actualizar el event listener del select
        document
          .getElementById('preset-schemas')
          .addEventListener('change', loadPresetSchema);
      });

      // Modificar el CSS para el botón de copiar
      function addCopyButtonStyles() {
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
          #copyButton {
            display: none; /* Oculto por defecto */
            margin-top: 1rem;
            background: linear-gradient(45deg, #4e91f6, #1e79e4);
            color: white;
            border: none;
            transition: all 0.3s ease;
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
          }

          #copyButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(78, 145, 246, 0.3);
          }

          @keyframes fadeIn {
            from {
              opacity: 0;
              transform: translateY(10px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        `;
        document.head.appendChild(styleSheet);
      }

      // Llamar a la función para agregar los estilos cuando se carga el documento
      document.addEventListener('DOMContentLoaded', addCopyButtonStyles);

      // Función para manejar el cambio de tema
      function toggleTheme() {
        const html = document.documentElement;
        const themeToggle = document.getElementById('themeToggle');
        const currentTheme = html.getAttribute('data-theme');

        if (currentTheme === 'dark') {
          html.removeAttribute('data-theme');
          localStorage.setItem('theme', 'light');
          themeToggle.innerHTML =
            '<i class="fas fa-moon"></i><span>Modo oscuro</span>';
        } else {
          html.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
          themeToggle.innerHTML =
            '<i class="fas fa-sun"></i><span>Modo claro</span>';
        }
      }

      // Inicializar tema basado en preferencia guardada
      document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme');
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        if (savedTheme === 'dark') {
          html.setAttribute('data-theme', 'dark');
          themeToggle.innerHTML =
            '<i class="fas fa-sun"></i><span>Modo claro</span>';
        } else {
          html.removeAttribute('data-theme');
          themeToggle.innerHTML =
            '<i class="fas fa-moon"></i><span>Modo oscuro</span>';
        }

        // Agregar evento click al botón
        themeToggle.addEventListener('click', toggleTheme);
      });
    </script>
  </body>
</html>
